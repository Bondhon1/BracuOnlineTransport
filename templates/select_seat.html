{% extends 'app.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Select Seat</h2>
    <div id="seat_grid" class="seat-grid mt-4">
        <p class="text-muted">Select an available seat below:</p>
    </div>
    <form id="otpForm" method="POST" action="{{ url_for('send_otp') }}">
        <input type="hidden" name="route_id" value="{{ route_id }}">
        <input type="hidden" name="journey_type" value="{{ journey_type }}">
        <input type="hidden" name="stop_id" value="{{ stop_id }}">
        <input type="hidden" id="seat_number" name="seat_number">
        <button type="submit" class="btn btn-primary mt-3" id="sendOtpBtn" disabled>Send OTP</button>
    </form>
</div>

<script>
    const userGender = "{{ user_gender }}";
    const reservedSeats = {{ reserved_seats | tojson | safe }};
    const seatNumbers = {{ seat_numbers | tojson | safe }};
    const maleSeats = {{ male_seats | tojson | safe }};
    const femaleSeats = {{ female_seats | tojson | safe }};

    console.log("User Gender:", userGender);
    console.log("Reserved Seats:", reservedSeats);

    const seatGrid = document.getElementById('seat_grid');
    const seatNumberInput = document.getElementById('seat_number');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    seatGrid.innerHTML = ''; // Clear grid

    seatNumbers.forEach(seat => {
        const seatDiv = document.createElement('div');
        seatDiv.className = 'seat';

        if (reservedSeats.includes(seat)) {
            seatDiv.classList.add('reserved');
            seatDiv.textContent = `${seat} (Already Booked)`;
        } else if (maleSeats.includes(seat) && userGender !== 'Male') {
            seatDiv.classList.add('reserved-male');
            seatDiv.textContent = `${seat} (Male Reserved)`;
        } else if (femaleSeats.includes(seat) && userGender !== 'Female') {
            seatDiv.classList.add('reserved-female');
            seatDiv.textContent = `${seat} (Female Reserved)`;
        } else {
            seatDiv.classList.add('available');
            seatDiv.textContent = seat;
            seatDiv.addEventListener('click', () => {
                // Highlight selected seat
                document.querySelectorAll('.seat.selected').forEach(s => s.classList.remove('selected'));
                seatDiv.classList.add('selected');
                seatNumberInput.value = seat;

                // Enable OTP button
                sendOtpBtn.disabled = false;
            });
        }

        seatGrid.appendChild(seatDiv);
    });
</script>

<style>
    .seat-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; }
    .seat { padding: 10px; text-align: center; cursor: pointer; border: 1px solid #ccc; border-radius: 5px; }
    .seat.available { background-color: #d4edda; cursor: pointer; } /* Green */
    .seat.reserved { background-color: #f8d7da; cursor: not-allowed; } /* Red */
    .seat.reserved-male { background-color: #cce5ff; cursor: not-allowed; } /* Blue */
    .seat.reserved-female { background-color: #f5c6cb; cursor: not-allowed; } /* Pink */
    .seat.selected { background-color: #ffc107; } /* Yellow */
</style>
{% endblock %}
